#!/bin/bash
# This script attempts to compile each test prefix generated by prefix.sh.
current_dir=$(realpath "$(dirname "${BASH_SOURCE[0]}")")
root_dir=$(dirname "${current_dir}")
# setup defects4j and sdkman
export PATH=$PATH:"${DEFECTS4J_HOME}"/framework/bin
source "${current_dir}/util/init_sdkman.sh"

while IFS=, read -r project_id bug_id modified_class; do
  qualifiers=$(echo "${modified_class}" | sed 's/\./\//g')
  # check for a given project or bug id
  if [ ${#} -gt 0 ]; then
    if [ "${project_id}" != "${1}" ]; then
      continue
    fi
    if [ ${#} -gt 1 ]; then
      if [ "${bug_id}" != "${2}" ]; then
        continue
      fi
    fi
  fi
  sdk use java "8.0.382-amzn"
  # checkout project
  project_dir="${root_dir}/temp/${project_id}_${bug_id}"
  defects4j checkout -p "${project_id}" -v "${bug_id}b" -w "${project_dir}"
  cd "${project_dir}" || exit 1
  test_dir="${project_dir}/$(defects4j export -p "dir.src.tests")"
  # remove original tests
  rm -r "${test_dir}"
  mkdir -p "$(dirname "${test_dir}/${qualifiers}Test.java")"
  # copy prefixes into empty test directory
  prefix_path="${root_dir}/src/main/evosuite-prefixes/${project_id}/${bug_id}/${qualifiers}Test.java"
  cp "${prefix_path}" "${test_dir}/${qualifiers}Test.java"
  # cd into project and test
  defects4j compile
  defects4j test
  # cleanup
  cd - || exit 1
  rm -r "${root_dir}/temp"
done < "${root_dir}/modified_classes.csv"
